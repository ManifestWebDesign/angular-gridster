/*
 * angular-gridster
 * http://manifestwebdesign.github.io/angular-gridster
 *
 * @version: 0.10.3
 * @license: MIT
 */
"use strict";angular.module("gridster",[]).constant("gridsterConfig",{columns:6,pushing:!0,floating:!0,width:"auto",colWidth:"auto",rowHeight:"match",margins:[10,10],outerMargin:!0,isMobile:!1,mobileBreakPoint:600,mobileModeEnabled:!0,minColumns:1,minRows:1,maxRows:100,defaultSizeX:2,defaultSizeY:1,resizable:{enabled:!0,handles:["s","e","n","w","se","ne","sw","nw"]},draggable:{enabled:!0}}).controller("GridsterCtrl",["gridsterConfig",function(a){angular.extend(this,a),this.resizable=angular.extend({},a.resizable||{}),this.draggable=angular.extend({},a.draggable||{}),this.grid=[],this.destroy=function(){this.grid&&(this.grid.length=0,this.grid=null)},this.setOptions=function(a){if(a)if(a=angular.extend({},a),a.draggable&&(angular.extend(this.draggable,a.draggable),delete a.draggable),a.resizable&&(angular.extend(this.resizable,a.resizable),delete a.resizable),angular.extend(this,a),this.margins&&2===this.margins.length)for(var b=0,c=this.margins.length;c>b;++b)this.margins[b]=parseInt(this.margins[b],10),isNaN(this.margins[b])&&(this.margins[b]=0);else this.margins=[0,0]},this.canItemOccupy=function(a,b,c){return b>-1&&c>-1&&a.sizeX+c<=this.columns&&a.sizeY+b<=this.maxRows},this.autoSetItemPosition=function(a){for(var b=0;b<this.maxRows;++b)for(var c=0;c<this.columns;++c){var d=this.getItems(b,c,a.sizeX,a.sizeY,a);if(0===d.length&&this.canItemOccupy(a,b,c))return void this.putItem(a,b,c)}throw new Error("Unable to place item!")},this.getItems=function(a,b,c,d,e){var f=[];c&&d||(c=d=1),!e||e instanceof Array||(e=[e]);for(var g=0;d>g;++g)for(var h=0;c>h;++h){var i=this.getItem(a+g,b+h,e);!i||e&&-1!==e.indexOf(i)||-1!==f.indexOf(i)||f.push(i)}return f},this.removeItem=function(a){for(var b=0,c=this.grid.length;c>b;++b){var d=this.grid[b];if(d){var e=d.indexOf(a);if(-1!==e){d[e]=null;break}}}this.floatItemsUp(),this.updateHeight()},this.getItem=function(a,b,c){!c||c instanceof Array||(c=[c]);for(var d=1;a>-1;){for(var e=1,f=b;f>-1;){var g=this.grid[a];if(g){var h=g[f];if(h&&(!c||-1===c.indexOf(h))&&h.sizeX>=e&&h.sizeY>=d)return h}++e,--f}--a,++d}return null},this.putItems=function(a){for(var b=0,c=a.length;c>b;++b)this.putItem(a[b])},this.putItem=function(a,b,c,d){if(("undefined"==typeof b||null===b)&&(b=a.row,c=a.col,"undefined"==typeof b||null===b))return void this.autoSetItemPosition(a);if(this.canItemOccupy(a,b,c)||(c=Math.min(this.columns-a.sizeX,Math.max(0,c)),b=Math.min(this.maxRows-a.sizeY,Math.max(0,b))),a&&null!==a.oldRow&&"undefined"!=typeof a.oldRow){if(a.oldRow===b&&a.oldColumn===c)return a.row=b,void(a.col=c);var e=this.grid[a.oldRow];e&&e[a.oldColumn]===a&&delete e[a.oldColumn]}a.oldRow=a.row=b,a.oldColumn=a.col=c,this.moveOverlappingItems(a,d),this.grid[b]||(this.grid[b]=[]),this.grid[b][c]=a},this.moveOverlappingItems=function(a,b){b?-1===b.indexOf(a)&&(b=b.slice(0),b.push(a)):b=[a];var c=this.getItems(a.row,a.col,a.sizeX,a.sizeY,b);this.moveItemsDown(c,a.row+a.sizeY,b)},this.moveItemsDown=function(a,b,c){if(a&&0!==a.length){a.sort(function(a,b){return a.row-b.row}),c=c?c.slice(0):[];var d,e,f,g={};for(e=0,f=a.length;f>e;++e){d=a[e];var h=g[d.col];("undefined"==typeof h||d.row<h)&&(g[d.col]=d.row)}for(e=0,f=a.length;f>e;++e){d=a[e];var i=b-g[d.col];this.moveItemDown(d,d.row+i,c),c.push(d)}}},this.moveItemDown=function(a,b,c){if(!(a.row>=b)){for(;a.row<b;)++a.row,this.moveOverlappingItems(a,c);this.putItem(a,a.row,a.col,c)}},this.floatItemsUp=function(){if(this.floating!==!1)for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)c[d]&&this.floatItemUp(c[d])}},this.floatItemUp=function(a){for(var b=a.col,c=a.sizeY,d=a.sizeX,e=null,f=null,g=a.row-1;g>-1;){var h=this.getItems(g,b,d,c,a);if(0!==h.length)break;e=g,f=b,--g}null!==e&&this.putItem(a,e,f)},this.updateHeight=function(a){var b=this.minRows;a||(a=0);for(var c=this.grid.length;c>=0;--c){var d=this.grid[c];if(d)for(var e=0,f=d.length;f>e;++e)d[e]&&(b=Math.max(b,c+a+d[e].sizeY))}this.gridHeight=this.maxRows-b>0?Math.min(this.maxRows,b):Math.max(this.maxRows,b)},this.pixelsToRows=function(a,b){return b===!0?Math.ceil(a/this.curRowHeight):b===!1?Math.floor(a/this.curRowHeight):Math.round(a/this.curRowHeight)},this.pixelsToColumns=function(a,b){return b===!0?Math.ceil(a/this.curColWidth):b===!1?Math.floor(a/this.curColWidth):Math.round(a/this.curColWidth)}}]).directive("gridster",["$timeout","$rootScope","$window",function(a,b,c){return{restrict:"EAC",transclude:!0,replace:!0,template:'<div ng-class="gridsterClass()"><div ng-style="previewStyle()" class="gridster-item gridster-preview-holder"></div><div class="gridster-content" ng-transclude></div></div>',controller:"GridsterCtrl",controllerAs:"gridster",scope:{config:"=?gridster"},compile:function(){return function(d,e,f,g){function h(){var a=parseInt(e.css("width"))||e.prop("offsetWidth");a===l||g.movingItem||(l=a,g.loaded&&e.removeClass("gridster-loaded"),j(),g.loaded&&e.addClass("gridster-loaded"))}function i(){h(),a(function(){d.$apply()})}g.loaded=!1,d.gridsterClass=function(){return{gridster:!0,"gridster-desktop":!g.isMobile,"gridster-mobile":g.isMobile,"gridster-loaded":g.loaded}},d.previewStyle=function(){return g.movingItem?{display:"block",height:g.movingItem.sizeY*g.curRowHeight-g.margins[0]+"px",width:g.movingItem.sizeX*g.curColWidth-g.margins[1]+"px",top:g.movingItem.row*g.curRowHeight+(g.outerMargin?g.margins[0]:0)+"px",left:g.movingItem.col*g.curColWidth+(g.outerMargin?g.margins[1]:0)+"px"}:{display:"none"}};var j=function(){g.setOptions(d.config),g.curWidth="auto"===g.width?parseInt(e.css("width"))||e.prop("offsetWidth"):g.width,g.curColWidth="auto"===g.colWidth?parseInt((g.curWidth+(g.outerMargin?-g.margins[1]:g.margins[1]))/g.columns):g.colWidth,g.curRowHeight="match"===g.rowHeight?g.curColWidth:g.rowHeight,g.isMobile=g.mobileModeEnabled&&g.curWidth<=g.mobileBreakPoint;for(var a=0,b=g.grid.length;b>a;++a){var c=g.grid[a];if(c)for(var f=0,h=c.length;h>f;++f)if(c[f]){var i=c[f];i.setElementPosition(),i.setElementSizeY(),i.setElementSizeX()}}k()};d.$watch("config",j,!0),d.$watch("config.draggable",function(){b.$broadcast("gridster-draggable-changed")},!0),d.$watch("config.resizable",function(){b.$broadcast("gridster-resizable-changed")},!0);var k=function(){e.css("height",g.gridHeight*g.curRowHeight+(g.outerMargin?g.margins[0]:-g.margins[0])+"px")};d.$watch("gridster.gridHeight",k);var l=parseInt(e.css("width"))||e.prop("offsetWidth");"function"==typeof e.resize&&e.resize(i);var m=angular.element(c);m.on("resize",i),d.$watch(function(){var a=parseInt(e.css("width"))||e.prop("offsetWidth");return a},h),d.$on("$destroy",function(){g.destroy(),m.off("resize",i)}),a(function(){d.$watch("gridster.floating",function(){g.floatItemsUp()}),g.loaded=!0},100)}}}}]).controller("GridsterItemCtrl",function(){this.$element=null,this.gridster=null,this.row=null,this.col=null,this.sizeX=null,this.sizeY=null,this.init=function(a,b){this.$element=a,this.gridster=b,this.sizeX=b.defaultSizeX,this.sizeY=b.defaultSizeY},this.destroy=function(){this.gridster=null,this.$element=null},this.toJSON=function(){return{row:this.row,col:this.col,sizeY:this.sizeY,sizeX:this.sizeX}},this.isMoving=function(){return this.gridster.movingItem===this},this.setPosition=function(a,b){this.gridster.putItem(this,a,b),this.gridster.loaded&&this.gridster.floatItemsUp(),this.gridster.updateHeight(this.isMoving()?this.sizeY:0),this.isMoving()||this.setElementPosition()},this.setSize=function(a,b){a=a.toUpperCase();var c="size"+a,d="Size"+a;if(""!==b){b=parseInt(b,10),(isNaN(b)||0===b)&&(b=this.gridster["default"+d]);var e=!(this[c]===b&&this["old"+d]&&this["old"+d]===b);this["old"+d]=this[c]=b,this.isMoving()||this["setElement"+d](),e&&(this.gridster.moveOverlappingItems(this),this.gridster.loaded&&this.gridster.floatItemsUp(),this.gridster.updateHeight(this.isMoving()?this.sizeY:0))}},this.setSizeY=function(a){this.setSize("y",a)},this.setSizeX=function(a){this.setSize("x",a)},this.setElementPosition=function(){this.$element.css(this.gridster.isMobile?{marginLeft:this.gridster.margins[0]+"px",marginRight:this.gridster.margins[0]+"px",marginTop:this.gridster.margins[1]+"px",marginBottom:this.gridster.margins[1]+"px",top:"",left:""}:{margin:0,top:this.row*this.gridster.curRowHeight+(this.gridster.outerMargin?this.gridster.margins[0]:0)+"px",left:this.col*this.gridster.curColWidth+(this.gridster.outerMargin?this.gridster.margins[1]:0)+"px"})},this.setElementSizeY=function(){this.gridster.isMobile?this.$element.css("height",""):this.$element.css("height",this.sizeY*this.gridster.curRowHeight-this.gridster.margins[0]+"px")},this.setElementSizeX=function(){this.gridster.isMobile?this.$element.css("width",""):this.$element.css("width",this.sizeX*this.gridster.curColWidth-this.gridster.margins[1]+"px")}}).factory("GridsterDraggable",["$document","$timeout",function(a,b){function c(c,d,e,f,g){function h(b){v=b.pageX,w=b.pageY,n=parseInt(c.css("left")),o=parseInt(c.css("top")),p=parseInt(c.css("width")),q=parseInt(c.css("height")),r=f.col,s=f.row,k(b),a.on("mousemove",i),a.on("mouseup",j),b.preventDefault(),b.stopPropagation()}function i(a){var b=e.curWidth-1;t=a.pageX,u=a.pageY;var d=t-v+x,f=u-w+y;x=y=0,v=t,w=u;var g=d,h=f;B>n+g?(d=B-n,x=g-d):n+p+g>b&&(d=b-n-p,x=g-d),z>o+h?(f=z-o,y=h-f):o+q+h>A&&(f=A-o-q,y=h-f),n+=d,o+=f,c.css({top:o+"px",left:n+"px"}),l(a),a.stopPropagation(),a.preventDefault()}function j(b){a.off("mouseup",j),a.off("mousemove",i),x=y=0,m(b)}function k(a){c.addClass("gridster-item-moving"),e.movingItem=f,e.updateHeight(f.sizeY),d.$apply(function(){e.draggable&&e.draggable.start&&e.draggable.start(a,c,g)})}function l(a){f.row=e.pixelsToRows(o),f.col=e.pixelsToColumns(n),d.$apply(function(){e.draggable&&e.draggable.drag&&e.draggable.drag(a,c,g)})}function m(a){c.removeClass("gridster-item-moving");var b=e.pixelsToRows(o),h=e.pixelsToColumns(n);(e.pushing!==!1||0===e.getItems(b,h,f.sizeX,f.sizeY,f).length)&&(f.row=b,f.col=h),e.movingItem=null;var i=r!==f.col||s!==f.row;d.$apply(function(){i&&e.draggable&&e.draggable.stop&&e.draggable.stop(a,c,g)}),f.setPosition(f.row,f.col),e.updateHeight()}var n,o,p,q,r,s,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=9999,B=0,C=!1,D=null;this.enable=function(){var a=this;b(function(){a.disable(),e.draggable&&e.draggable.handle?(D=angular.element(c[0].querySelector(e.draggable.handle)),0===D.length&&(D=c)):D=c,D.on("mousedown",h),C=!0})},this.disable=function(){C&&(a.off("mouseup",j),a.off("mousemove",i),D&&D.off("mousedown",h),C=!1)},this.toggle=function(a){a?this.enable():this.disable()},this.destroy=function(){this.disable()}}return c}]).factory("GridsterResizable",["$document",function(a){function b(b,c,d,e,f){function g(g){function h(c){w=c.pageX,x=c.pageY,n=parseInt(b.css("left")),o=parseInt(b.css("top")),p=parseInt(b.css("width")),q=parseInt(b.css("height")),r=e.sizeX,s=e.sizeY,i(c),a.on("mousemove",j),a.on("mouseup",k),c.preventDefault(),c.stopPropagation()}function i(a){b.addClass("gridster-item-moving"),d.movingItem=e,e.setElementSizeX(),e.setElementSizeY(),e.setElementPosition(),c.$apply(function(){d.resizable&&d.resizable.start&&d.resizable.start(a,b,f)})}function j(a){var c=d.curWidth-1;u=a.pageX,v=a.pageY;var e=u-w+y,f=v-x+z;y=z=0,w=u,x=v;var g=f,h=e;t.indexOf("n")>=0&&(D>q-g?(f=q-D,z=g-f):A>o+g&&(f=A-o,z=g-f),o+=f,q-=f),t.indexOf("s")>=0&&(D>q+g?(f=D-q,z=g-f):o+q+g>B&&(f=B-o-q,z=g-f),q+=f),t.indexOf("w")>=0&&(E>p-h?(e=p-E,y=h-e):C>n+h&&(e=C-n,y=h-e),n+=e,p-=e),t.indexOf("e")>=0&&(E>p+h?(e=E-p,y=h-e):n+p+h>c&&(e=c-n-p,y=h-e),p+=e),b.css({top:o+"px",left:n+"px",width:p+"px",height:q+"px"}),l(a),a.preventDefault(),a.stopPropagation()}function k(b){a.off("mouseup",k),a.off("mousemove",j),y=z=0,m(b)}function l(a){e.row=d.pixelsToRows(o,!1),e.col=d.pixelsToColumns(n,!1),e.sizeX=d.pixelsToColumns(p,!0),e.sizeY=d.pixelsToRows(q,!0),c.$apply(function(){d.resizable&&d.resizable.resize&&d.resizable.resize(a,b,f)})}function m(a){b.removeClass("gridster-item-moving"),d.movingItem=null,e.setPosition(e.row,e.col),e.setSizeY(e.sizeY),e.setSizeX(e.sizeX);var g=r!==e.sizeX||s!==e.sizeY;c.$apply(function(){g&&d.resizable&&d.resizable.stop&&d.resizable.stop(a,b,f)})}var n,o,p,q,r,s,t=g,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=9999,C=0,D=d.curRowHeight-d.margins[0],E=d.curColWidth-d.margins[1],F=null;this.enable=function(){F||(F=angular.element('<div class="gridster-item-resizable-handler handle-'+t+'"></div>'),b.append(F)),F.on("mousedown",h)},this.disable=function(){F&&(F.off("mousedown",h),F.remove(),F=null),a.off("mouseup",k),a.off("mousemove",j)},this.destroy=function(){this.disable()}}for(var h=[],i=!1,j=0,k=d.resizable.handles.length;k>j;j++)h.push(new g(d.resizable.handles[j]));this.enable=function(){if(!i){for(var a=0,b=h.length;b>a;a++)h[a].enable();i=!0}},this.disable=function(){if(i){for(var a=0,b=h.length;b>a;a++)h[a].disable();i=!1}},this.toggle=function(a){a?this.enable():this.disable()},this.destroy=function(){for(var a=0,b=h.length;b>a;a++)h[a].destroy()}}return b}]).directive("gridsterItem",["$parse","$timeout","GridsterDraggable","GridsterResizable",function(a,b,c,d){return{restrict:"EA",controller:"GridsterItemCtrl",require:["^gridster","gridsterItem"],link:function(b,e,f,g){function h(){l.setPosition(l.row,l.col),o.row&&o.row.assign&&o.row.assign(b,l.row),o.col&&o.col.assign&&o.col.assign(b,l.col)}var i,j=f.gridsterItem,k=g[0],l=g[1];if(j){var m=a(j);i=m(b)||{},!i&&m.assign&&(i={row:l.row,col:l.col,sizeX:l.sizeX,sizeY:l.sizeY},m.assign(b,i))}else i=f;l.init(e,k),e.addClass("gridster-item");for(var n=["sizeX","sizeY","row","col"],o={},p=function(c){var d;if("string"==typeof i[c])d=i[c];else if("string"==typeof i[c.toLowerCase()])d=i[c.toLowerCase()];else{if(!j)return;d=a(j+"."+c)}o[c]=a(d),b.$watch(d,function(a){a=parseInt(a,10),isNaN(a)||(l[c]=a)});var e=o[c](b);"number"==typeof e&&(l[c]=e)},q=0,r=n.length;r>q;++q)p(n[q]);b.$watch(function(){return l.row},h),b.$watch(function(){return l.col},h),b.$watch(function(){return l.sizeY},function(a){l.setSizeY(a),o.sizeY&&o.sizeY.assign&&o.sizeY.assign(b,l.sizeY)}),b.$watch(function(){return l.sizeX},function(a){l.setSizeX(a),o.sizeX&&o.sizeX.assign&&o.sizeX.assign(b,l.sizeX)});var s=new c(e,b,k,l,i),t=new d(e,b,k,l,i);return b.$on("gridster-draggable-changed",function(){s.toggle(k.draggable&&k.draggable.enabled)}),b.$on("gridster-resizable-changed",function(){t.toggle(k.resizable&&k.resizable.enabled)}),k.draggable&&k.draggable.enabled&&s.enable(),k.resizable&&k.resizable.enabled&&t.enable(),b.$on("$destroy",function(){try{t.destroy(),s.destroy()}catch(a){}try{k.removeItem(l)}catch(a){}try{l.destroy()}catch(a){}})}}}]);