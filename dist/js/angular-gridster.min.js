/**
 * @file angular-gridster - http://manifestwebdesign.github.io/angular-gridster
 * @module angular-gridster
 * 
 * @see http://manifestwebdesign.github.io/angular-gridster
 * @version 0.9.8
 * @license MIT
 */
!function(a){"use strict";var b=a.module("gridster",[]);b.constant("gridsterConfig",{modes:{desktop:{columns:12,minThreshold:1025,maxThreshold:9999,defaultSizeX:3,defaultSizeY:3,minSizeX:3,minSizeY:2},tablet:{columns:12,minThreshold:768,maxThreshold:1024,defaultSizeX:4,defaultSizeY:4,minSizeX:4,minSizeY:2},mobile:{columns:6,minThreshold:0,maxThreshold:767,defaultSizeX:6,defaultSizeY:6,minSizeX:6,minSizeY:3}},width:"auto",colWidth:"auto",rowHeight:"match",margins:[10,10],minItemWidth:100,minItemHeight:100,minRows:12,maxRows:1e3,trackByProperty:"id",rowProperty:"row",colProperty:"col",sizeXProperty:"sizeX",sizeYProperty:"sizeY",floatItemsUp:!0,moveOverlappingItems:!0,resizableEnabled:!0,iframeFix:!0,resizablePreviewEnabled:!0,draggablePreviewEnabled:!0}),b.controller("GridsterCtrl",["$scope","$rootScope","gridsterConfig",function(b,c,d){var e=null,f=null;b.itemElements=[],this.init=function(c){e=c,f=c[0].querySelector(".gridster-preview-holder"),b.options=a.extend({},d),a.extend(b.options,b.config)},this.getOption=function(a){return b.options.modes[b.options.mode].hasOwnProperty(a)?b.options.modes[b.options.mode][a]:b.options[a]},this.addItemElement=function(a,c){b.itemElements[a]=c},this.getItemElement=function(a){return b.itemElements[a]},this.removeItemElement=function(a){delete b.itemElements[a]},this.setLoaded=function(a){a===!0?(b.options.isLoaded=!0,c.$broadcast("angular-gridster.loaded"),e.addClass("gridster-loaded")):(e.removeClass("gridster-loaded"),b.options.isLoaded=!1)},this.resolveOptions=function(){var a,d,f;b.options.curWidth=e[0].offsetWidth,e.removeClass("gridster-"+b.options.mode);for(a in b.options.modes)if(b.options.modes.hasOwnProperty(a)&&a!==b.options.mode&&(d=b.options.modes[a],b.options.curWidth>=d.minThreshold&&b.options.curWidth<=d.maxThreshold)){f=!0,b.options.mode=a;break}e.addClass("gridster-"+b.options.mode),"auto"!==this.getOption("width")&&(b.options.curWidth=this.getOption("width")),b.options.curColWidth="auto"===this.getOption("colWidth")?(b.options.curWidth-this.getOption("margins")[0])/this.getOption("columns"):this.getOption("colWidth"),b.options.curRowHeight="match"===this.getOption("rowHeight")?b.options.curColWidth:this.getOption("rowHeight"),b.options.isLoaded===!0&&(c.$broadcast("angular-gridster.grid_changed",b.options),f===!0&&this.moveAllOverlappingItems())},this.showPreviewElement=function(){f.style.opacity="1"},this.hidePreviewElement=function(){f.style.opacity="0"},this.startMove=function(){e.addClass("gridster-moving")},this.endMove=function(){e.removeClass("gridster-moving")},this.canItemOccupy=function(a,b,c,d,e){var f=!0;return(0>a||0>b||a+d>this.getOption("maxRows")||b+c>this.getOption("columns")||this.getItemsInArea(a,b,c,d,e).length>0)&&(f=!1),f},this.getItemsInArea=function(a,c,d,e,f){var g,h,i=[];h=this.getOption("trackByProperty"),!f||f instanceof Array||(f=[f]);a:for(var j=0,k=b.items.length;k>j;j++){if(g=b.items[j],f)for(var l=0,m=f.length;m>l;l++)if(f[l][h]===g[h])continue a;this.isItemHidden(g)!==!0&&this.isItemInArea(g,a,c,d,e)&&i.unshift(g)}return i},this.isItemInArea=function(a,b,c,d,e){var f,g,h,i;return f=this.getRow(a),g=this.getCol(a),h=this.getSizeX(a),i=this.getSizeY(a),b>=f+i||f>=b+e||c>=g+h||g>=c+d?!1:!0},this.resolveParam=function(a,b,c){if(a=parseInt(a,10),null===a||isNaN(a)||"number"!=typeof a||0>a){if("undefined"!=typeof b)return this.resolveParam(b,c);if("undefined"!=typeof c)return this.resolveParam(c);a=null}return a},this.fixItem=function(a){var c,d,e,f,g,h,i=a,j=b.options.mode,k=this.getOption("defaultSizeX"),l=this.getOption("defaultSizeY");for(c in b.options.modes){if(b.options.mode=c,d=this.resolveParam(this.getSizeX(i),k),d<this.getOption("minSizeX")&&(d=k),i=this.setSizeX(i,d),e=this.resolveParam(this.getSizeY(i),l),e<this.getOption("minSizeY")&&(e=l),i=this.setSizeY(i,e),f=this.resolveParam(this.getRow(i)),g=this.resolveParam(this.getCol(i)),"number"!=typeof f||"number"!=typeof g||f>this.getOption("maxRows")||g>=this.getOption("columns"))if(b.options.isLoaded===!0){if(h=this.getNextPosition(d,e,a),h===!1&&(i=this.setSizeX(i,k),i=this.setSizeY(i,l),h=this.getNextPosition(null,null,a),h===!1))throw new Error("No positions available");f=h.row,g=h.col}else f=0,g=0;i=this.setRow(i,f),i=this.setCol(i,g)}return b.options.mode=j,b.items[b.items.indexOf(a)]=i,i},this.getNextPosition=function(a,b,c){a=a||this.getOption("defaultSizeX"),b=b||this.getOption("defaultSizeY");for(var d=0,e=this.getOption("maxRows");e>=d;d++)for(var f=0,g=this.getOption("columns");g>f;f++)if(this.canItemOccupy(d,f,a,b,c))return{row:d,col:f};return!1},this.moveOverlappingItems=function(a,c){var d,e,f,g,h,i,j,k,l;if(this.getOption("moveOverlappingItems")!==!1&&!this.isItemHidden(a)){e=this.getRow(a),f=this.getCol(a),g=this.getSizeX(a),h=this.getSizeY(a),d=this.getItemsInArea(e,f,g,h,a);for(var m=0,n=d.length;n>m;m++)i=this.getRow(d[m]),j=this.getCol(d[m]),k=this.getSizeX(d[m]),l=this.getSizeY(d[m]),c===!0&&e>0&&this.canItemOccupy(i-(h+l-1),j,k,l,d[m])?d[m]=this.setRow(d[m],i-(h+l-1)):(d[m]=this.setRow(d[m],e+h),this.moveOverlappingItems(d[m])),b.options.isLoaded&&this.translateElementPosition(this.getItemElement(d[m][this.getOption("trackByProperty")]),this.colToPixels(this.getCol(d[m])),this.rowToPixels(this.getRow(d[m])))}},this.moveAllOverlappingItems=function(){if(0!==b.items.length)for(var a=0,c=b.items.length;c>a;a++)this.moveOverlappingItems(b.items[a])},this.floatItemsUp=function(){if(this.getOption("floatItemsUp")!==!1&&b.items)for(var a=0;a<b.items.length;a++)b.items[a]._moving!==!0&&this.floatItemUp(b.items[a])},this.floatItemUp=function(a){var b,c,d,e,f,g=null;for(c=this.getRow(a)-1,d=this.getCol(a),e=this.getSizeX(a),f=this.getSizeY(a);c>-1&&(b=this.getItemsInArea(c,d,e,f,a),0===b.length);)g=c,--c;null!==g&&(a=this.setRow(a,g),this.translateElementPosition(this.getItemElement(a[this.getOption("trackByProperty")]),this.colToPixels(d),this.rowToPixels(g)))},this.updateGridHeight=function(){var a,c,d=0;if(d=this.getOption("minRows"),b.items)for(var f=0;f<b.items.length;f++)a=this.getRow(b.items[f])+this.getSizeY(b.items[f]),a>d&&(d=a);d+=this.getOption("defaultSizeY"),d>this.getOption("maxRows")&&(d=this.getOption("maxRows")),c=d*this.getOption("curRowHeight")+this.getOption("margins")[1],e[0].style.height=c+"px"},this.pixelsToRows=function(a,b){var c;return(!a||0>a)&&(a=0),c=b===!0?Math.ceil(a/this.getOption("curRowHeight")):b===!1?Math.floor(a/this.getOption("curRowHeight")):Math.round(a/this.getOption("curRowHeight"))},this.pixelsToColumns=function(a,c){var d;return(!a||0>a)&&(a=0),d=c===!0?Math.ceil(a/b.options.curColWidth):c===!1?Math.floor(a/b.options.curColWidth):Math.round(a/b.options.curColWidth)},this.rowToPixels=function(a){return a*b.options.curRowHeight+this.getOption("margins")[0]},this.colToPixels=function(a){return a*b.options.curColWidth+this.getOption("margins")[1]},this.translateElementPosition=function(a,b,c){var d;null===a&&(a=f),d=Modernizr.csstransforms3d?"translate3d("+b+"px,"+c+"px, 0)":"translate("+b+"px,"+c+"px)",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.OTransform=d,a.style.msTransform=d,a.style.transform=d},this.setElementHeight=function(a,c){var d;return b.options.isLoaded?(d=parseFloat((c*b.options.curRowHeight).toFixed(2),10)-this.getOption("margins")[0]+"px",null===a&&(a=f),a.style.height=d,b.$broadcast("angular_gridster.element_height_changed",a,d),d):0},this.setElementWidth=function(a,c){var d;return null===a&&(a=f),d=parseFloat((c*b.options.curColWidth).toFixed(2))-this.getOption("margins")[1]+"px",a.style.width=d,d},this.setElement=function(a,b,c){return null!==a&&this.isItemHidden(b)?void(a.style.display="none"):(null!==a&&(a.style.display="block"),null===a&&(a=f),this.setElementWidth(a,this.getSizeX(b)),this.translateElementPosition(a,this.colToPixels(this.getCol(b)),this.rowToPixels(this.getRow(b))),void(c||this.setElementHeight(a,this.getSizeY(b))))},this.setElements=function(){for(var a=0;a<b.items.length;a++)this.setElement(this.getItemElement(b.items[a][this.getOption("trackByProperty")]),b.items[a])},this.hasItemPositionChanged=function(a,b,c){return this.getRow(a)!==b||this.getCol(a)!==c?!0:!1},this.hasItemWidthChanged=function(a,b){return this.getSizeX(a)!==b?!0:!1},this.hasItemHeightChanged=function(a,b){return this.getSizeY(a)!==b?!0:!1},this.getItemProperty=function(a,c){return a.hasOwnProperty(b.options.mode)?(a[b.options.mode].hasOwnProperty(c)||(a[b.options.mode][c]=0),a[b.options.mode][c]):null},this.setItemProperty=function(a,c,d){return a.hasOwnProperty(b.options.mode)||(a[b.options.mode]={}),a[b.options.mode][c]=d,a},this.getRow=function(a){return this.getItemProperty(a,b.options.rowProperty)},this.setRow=function(a,c){return this.setItemProperty(a,b.options.rowProperty,c)},this.getCol=function(a){return this.getItemProperty(a,b.options.colProperty)},this.setCol=function(a,c){var d=this.getSizeX(a);return c+d>this.getOption("columns")&&(c=this.getOption("columns")-d),this.setItemProperty(a,b.options.colProperty,c)},this.getSizeX=function(a){return this.getItemProperty(a,b.options.sizeXProperty)},this.setSizeX=function(a,c){var d=this.getOption("minSizeX");d>c&&(c=d);var e=this.getOption("columns");return c>e&&(c=e),this.setItemProperty(a,b.options.sizeXProperty,c)},this.getSizeY=function(a){return this.getItemProperty(a,b.options.sizeYProperty)},this.setSizeY=function(a,c){var d=this.getOption("minSizeY");d>c&&(c=d);var e=this.getOption("maxRows");return c>e&&(c=e),this.setItemProperty(a,b.options.sizeYProperty,c)},this.isItemHidden=function(a){return a.hasOwnProperty(b.options.mode)?a[b.options.mode].hidden:!1},this.setGestureItem=function(a){b.gestureItem=a},this.setGestureElement=function(a){b.gestureElement=a}}]),b.directive("gridster",["$window","$timeout",function(b,c){return{restrict:"EA",controller:"GridsterCtrl",scope:{items:"=",config:"=?gridster",api:"=?"},template:'<div class="gridster"><div ng-repeat="item in items track by item[options.trackByProperty]" gridster-item="item" gridster-options="options" class="gridster-item"><div class="gridster-item-content" inject></div><div class="resize-s-handle"></div><div class="resize-e-handle"></div><div class="gridster-item-overlay"></div></div><div class="gridster-preview-holder"></div></div>',replace:!0,transclude:!0,link:function(d,e,f,g){var h=null;d.api={getNextPosition:function(a,b){return g.getNextPosition(a,b)},getOption:function(a){return d.options[a]},setOption:function(a,b){d.options[a]=b}};var i=function(a){a.target===b&&null===h&&(h=c(function(){g.resolveOptions(),h=null},200))};a.element(b).bind("resize",i),d.$on("$destroy",function(){a.element(b).unbind("resize",i)}),g.init(e),interact.supportsTouch()===!0}}}]),b.directive("gridsterItem",["$timeout",function(a){return{restrict:"A",require:"^gridster",replace:!0,scope:{item:"=gridsterItem"},link:function(b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=c[0],z=null,A=null,B=null,C=!1,D=!1,E=!1,F=!1;b.$parent.$first&&(e.setLoaded(!1),e.resolveOptions()),y.style.display=e.isItemHidden(b.item)===!0?"none":"block",e.fixItem(b.item),e.addItemElement(b.item[e.getOption("trackByProperty")],y),e.setElement(y,b.item,!0);var G=function(){var a,b=c.css("-webkit-transform")||c.css("-moz-transform")||c.css("-ms-transform")||c.css("-o-transform")||c.css("transform");if("string"!=typeof b||"none"===b)throw new Error("Your browser does not support css transforms");a=b.split("(")[1].split(")")[0].split(","),a.length<4?(q=parseInt(a[0].replace("px",""),10),p=parseInt(a[1].replace("px",""),10)):(q=parseInt(a[4].replace("px",""),10),p=parseInt(a[5].replace("px",""),10))},H=function(a){b.$watch("item."+a,function(a,d){a!==d&&a._moving!==!0&&(b.item=e.fixItem(b.item),e.moveOverlappingItems(b.item),e.floatItemUp(b.item),e.updateGridHeight(),e.setElement(y,b.item),b.$emit("angular-gridster.item_changed",b.item,c))},!0)};for(var I in e.getOption("modes"))H(I);var J=function(){z=interact(y).draggable({onstart:function(a){e.startMove(),D=!0,b.item._moving=!0,x=e.getOption("columns"),h=e.getRow(b.item),i=e.getCol(b.item),j=e.getSizeX(b.item),k=e.getSizeY(b.item),e.getOption("draggablePreviewEnabled")===!0&&e.showPreviewElement(),e.updateGridHeight(),e.setElement(null,b.item),G(),f=e.getOption("draggable"),f&&f.onstart&&f.onstart(a,c),c.addClass("gridster-item-moving")},onmove:function(a){if(q+=a.dx,p+=a.dy,e.translateElementPosition(y,q,p),l=e.pixelsToRows(p),m=e.pixelsToColumns(q),m+j>=x&&(m=x-j),e.hasItemPositionChanged(b.item,l,m)){if(!e.getOption("moveOverlappingItems")&&!e.canItemOccupy(l,m,j,k,b.item))return;b.item=e.setRow(b.item,l),b.item=e.setCol(b.item,m),e.getOption("draggablePreviewEnabled")===!0&&e.translateElementPosition(null,e.colToPixels(m),e.rowToPixels(l)),e.moveOverlappingItems(b.item,!0),e.updateGridHeight()}f&&f.onmove&&f.onmove(a,c)},onend:function(a){D=!1,delete b.item._moving,c.removeClass("gridster-item-moving"),b.$apply(function(){e.getOption("draggablePreviewEnabled")===!0&&e.hidePreviewElement(),e.hasItemPositionChanged(b.item,h,i)===!1&&e.translateElementPosition(y,e.colToPixels(i),e.rowToPixels(h)),e.floatItemsUp(),e.endMove(),f&&f.onend&&f.onend(a,c)})}}).actionChecker(function(a,b){return"undefined"!=typeof a.button?0===a.button?b:null:b});var a=function(a){e.startMove(),C=!0,b.item._moving=!0,e.updateGridHeight(),e.getOption("resizablePreviewEnabled")===!0&&e.showPreviewElement(),c.addClass("gridster-item-moving"),h=e.getRow(b.item),i=e.getCol(b.item),j=e.getSizeX(b.item),k=e.getSizeY(b.item),r=y.offsetWidth,s=y.offsetHeight,t=e.getOption("minSizeX")*e.getOption("curColWidth")-e.getOption("margins")[0],u=(e.getOption("columns")-i)*e.getOption("curColWidth")-e.getOption("margins")[0],v=e.getOption("minSizeY")*e.getOption("curRowHeight")-e.getOption("margins")[1],w=(e.getOption("maxRows")-h)*e.getOption("curColHeight"),e.setElement(null,b.item),g=e.getOption("resizable"),g&&g.start&&g.start(a,c)},d=function(a,d,f){if(d>u?d=u:t>d&&(d=t),f>w?f=w:v>f&&(f=v),y.style.width=d+"px",y.style.height=f+"px",n=e.pixelsToColumns(d,!0),o=e.pixelsToRows(f,!0),F=e.hasItemWidthChanged(b.item,n),E=e.hasItemHeightChanged(b.item,o),F||E){if(e.getOption("moveOverlappingItems")===!1&&e.canItemOccupy(l,m,n,o,b.item)===!1)return;b.item=e.setSizeX(b.item,n),b.item=e.setSizeY(b.item,o),e.moveOverlappingItems(b.item),E&&e.updateGridHeight(),e.getOption("resizablePreviewEnabled")===!0&&(e.setElementWidth(null,n),e.setElementHeight(null,o))}g&&g.onmove&&g.onmove(a,c,{width:d,height:f})},H=function(a){C=!1,delete b.item._moving,c.removeClass("gridster-item-moving"),b.$apply(function(){e.getOption("resizablePreviewEnabled")===!0&&e.hidePreviewElement(),e.hasItemWidthChanged(b.item,j)===!1&&e.hasItemHeightChanged(b.item,k)===!1&&(e.setElementWidth(y,n),e.setElementHeight(y,o)),e.floatItemsUp(),e.endMove(),g&&g.onend&&g.onend(a,c,{width:r,height:s})})};if(e.getOption("resizableEnabled"))if(interact.supportsTouch()===!0){var I,J,K=!1;b.$on("gridster.gesture_reset",function(){K=!1}),b.$on("gridster.gesture_start",function(b){K&&($("body").append("<div>start</div>"),a(b))}),b.$on("gridster.gesture_move",function(a,b){K&&(I=r*b.scale,J=s*b.scale,y.style.width=I+"px",y.style.height=J+"px",d(a,I,J))}),b.$on("gridster.gesture_end",function(a){K&&($("body").append("<div>stop</div>"),K=!1,H(a))})}else A=interact(y.querySelector(".resize-e-handle")).resizable({onstart:a,onmove:function(a){r+=a.dx,s+=a.dy,d(a,r,s)},onend:H}).actionChecker(function(a,b){return"undefined"!=typeof a.button?0===a.button?b:null:b}),B=interact(y.querySelector(".resize-s-handle")).resizable({axis:"y",onstart:a,onmove:function(a){r+=a.dx,s+=a.dy,d(a,r,s)},onend:H}).actionChecker(function(a,b){return"undefined"!=typeof a.button?0===a.button?b:null:b})},K=function(){null!==z&&(z.unset(),z=null),null!==A&&(A.unset(),A=null),null!==B&&(B.unset(),B=null)};b.$on("angular-gridster.grid_changed",function(){e.setElement(y,b.item)}),b.$on("angular-gridster.loaded",function(){e.setElementHeight(y,e.getSizeY(b.item)),J()}),b.$on("$destroy",function(){e.removeItemElement(b.item[e.getOption("trackByProperty")]),K()}),b.$parent.$last&&(a(function(){e.setLoaded(!0),e.moveAllOverlappingItems(),e.updateGridHeight()},50),a(function(){e.resolveOptions()},1e3))}}}]),b.directive("inject",function(){return{link:function(a,b,c,d,e){var f=a.$new();e(f,function(a){b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()})})}}})}(angular);